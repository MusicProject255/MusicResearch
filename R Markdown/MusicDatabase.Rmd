---
title: "MusicDatabase"
author: Collin Smith, Conor Burrows, Jake Luedtke, Nicholas Melon
date: "January 25, 2017"
output: html_document
---
#Overview
  
In our group our main focus is to determine what genre is the most popular in each decade starting with 1900 and going up to 2016. We also are going to look at which genres are more popular in eruope compared to the U.S and if the words in a song title have a effect on how popular a song is. We are going to use music brainz to get the genre of a song, it's mood quality, and tempo. With this information we will be able to see the trends better in preffered music choice for each decade. In the end we may use the database to make a simple song finder based on your taste in genre, tempo, and mood.


##Code used to get data
```{r eval=FALSE}
library(stringr)
#Get dataset and look at name and title
allsongs <- read.csv("tsort-chart-2-6-0013.csv")
#nsongs <- allsongs[,1:2]
rsongs <- allsongs[,1:3]
justsongs<- rsongs[(rsongs$type=="song"),]
justalbums <- rsongs[(rsongs$type=="album"),]
#Set as characters
csongs <- as.character(justsongs$name)
calbums <- as.character(justalbums$name)
#Make sure song names are in correct format
csongs <- tolower(csongs)
csongs <- str_extract_all(csongs, boundary("word"))
calbums <- tolower(calbums)
calbums <- str_extract_all(calbums, boundary("word"))


#Empty list for words
words <- list()
#Function looks at song titles, splits them up into words, adds them to a list and keeps track of number 
dtf <- data.frame()
for (x in 1:length(csongs)){
  title <- csongs[[x]]
  for (y in 1:length(title)){
    word <- title[[y]]
    if(exists(word, words)){
      words[[word]] <- words[[word]] + 1
    }else{
      words[[word]] <- 1
    }
  }
}
worda <- list()
#Function looks at song titles, splits them up into words, adds them to a list and keeps track of number
top5 <- as.character(top5000$name)
#Make sure song names are in correct format
top5 <- tolower(top5)
top5 <- str_extract_all(csongs, boundary("word"))
dtfa <- data.frame()
for (b in 1:length(calbums)){
  titlea <- calbums[[b]]
  for (c in 1:length(titlea)){
    aword <- titlea[[c]]
    if(exists(aword, worda)){
      worda[[aword]] <- worda[[aword]] + 1
    }else{
      worda[[aword]] <- 1
    }
  }
}

#Formatting Data and saving
mdf <- as.data.frame(words)
gmdf <- t(mdf)
colnames(gmdf) <- c("Instances")
write.table(gmdf, file = "songvalues.csv")
#formatting album data
mdfa <- as.data.frame(worda)
gmdfa <- t(mdfa)
colnames(gmdfa) <- c("Instances")
write.table(gmdfa, file = "albumvalues.csv")

top5 <- as.character(top5000$name)
top5 <- tolower(top5)
top5 <- str_extract_all(csongs, boundary("word"))
wordcount <- function(list){
  words <<- list()
  dtf <<- data.frame()
  for (x in 1:length(list)){
    title <<- list[[x]]
      for (y in 1:length(title)){
        word <<- title[[y]]
        if(exists(word, words)){
          words[[word]] <<- words[[word]] + 1
    }   else{
          words[[word]] <<- 1
    }
  }
  }
}
mdf <- as.data.frame(words)
gmdf <- t(mdf)
colnames(gmdf) <- c("Instances")
write.table(gmdf, file = "songvalues5000.csv")


#Search through 5000 for words and get their values
corectv5tes$word <- as.character(corectv5tes$word)
withztes$name <- as.character(withztes$name)
corectv5tes$word <- str_extract_all(corectv5tes$word, boundary("word"))
withztes$name <- tolower(withztes$name)
corectv5tes$word <- str_extract_all(corectv5tes$word, boundary("word"))


colnames(corectv5[3:6]) <- c("U.S","Eng","Eur","Row")
score <- 0
mean <- 0
#Replaced the columns each time
for (x in 1:3452){
  #doesn't return duplicates
  wappear <- grep(corectv5tes$word[[x]], withztes$name)
  for(y in wappear){
    score <- sum(withztes$z_row[[y]], na.rm = TRUE)
    mean <- mean + 1
    }
  scorer <- (score/mean)
  corectv5tes$Row[[x]] <- scorer
  score <- 0
      
    
  }
case <- corectv5tes
#wasn't formatted correctly so used original songs
valuetable <- corectv5tes[,3:6]
corectv5help[,3:6] <- valuetable
write.table(corectv5help,"5000popularitywords.csv")


#Didn't work out for meta data
dat <-  readLines("metadata5000e.txt")
dats <- str_split(dat, ':')
#9,22/28, 71/74/77, 83
#Mood, Tempo, Stlye, Male or Female
datsq <- lapply(dats, noquote)
#datsqe <- str_extract_all(datsq, boundary("word"))
#tese <- unlist(datsq)
#sapply(datsq[[7]], grepl, "mood")
datsq[[1]] <- NULL
#tester <- datsq[[1]]
emptyl <- list()
nob <- list()
for(x in 1:length(datsq)){
  nob[[x]] <- gsub("\\{|\\}", "", datsq[[x]])
}
nextes <- nob[[1]]

```

##Formating metadata
```{r eval=FALSE}
library(stringr)

top5meta <- read.csv("top5000plus.csv")
top5meta[,1:2] <- NULL
colnames(top5meta) <- 
c("artist" ,"name", "year","finalscore","rawusa","raweng","raweur","rawrow","zusa","zeng","zeur","zrow", "decade","mood1","mood2","artistera1","artistera2","tempo1","exacttempo","tempo2","artistorigin1","artistoriginspecific","artistorigin2","artistorigin4","genre1","genreSpec","genre2","artisttype1",
"artisttype2")
top5meta$tempo1 <- gsub(" Tempo", "" ,top5meta$tempo1)
#Not splitting up mood 2 by / or " "

#gets genre, mood, tempo, artist
#Not right
wordstat <- function(word){
  wholewordinfo <<- data.frame()
  formt <- str_extract_all(tolower(top5meta$name), boundary("word"))
  wordloc <- grep(word, formt)
  for(x in wordloc){
    wholewordinfo[x,1] <<- word
    wholewordinfo[x,2] <<- top5meta$genre1[x]
    wholewordinfo[x,3] <<- top5meta$genreSpec[x]
    wholewordinfo[x,4] <<- top5meta$genre2[x]
    wholewordinfo[x,5] <<- top5meta$mood1[x]
    wholewordinfo[x,6] <<- top5meta$mood2[x]
    wholewordinfo[x,7] <<- top5meta$tempo1[x]
    wholewordinfo[x,8] <<- top5meta$exacttempo[x]
    wholewordinfo[x,9] <<- top5meta$tempo2[x]
    wholewordinfo[x,10] <<- top5meta$artisttype1[x]
    wholewordinfo[x,11] <<- top5meta$artistera1[x] 
  }
  
}
#Gets the first column, next function (kinda) does the rest
wordvalue <- data.frame() 
wordstatr <- function(word){
  wordinfo <- vector()
  formt <- str_extract_all(tolower(top5meta$name), boundary("word"))
  wordloc <- grep(word, formt)
  for(x in wordloc){
    wordinfo <- append(wordinfo, as.character(top5meta$mood1[x]))
  
  }
  top <- names(which.max(table(wordinfo)))
  #some have NA values
  if(length(top) == 0){
    wordvalue[(nrow(wordvalue)+1),1] <<- word
    wordvalue[(nrow(wordvalue)),2] <<- NA

  }
  else{
    wordvalue[(nrow(wordvalue)+1),1] <<- word
    wordvalue[(nrow(wordvalue)),2] <<- top
  }
}

#Get word stats
wlist <- as.list(corectv5help[,1])
wordlistv <- lapply(wlist, wordstatr)

#backup <- wordv
#wordv <- backup
wordvalue <- backup
#Get the rest of information
rplace <- 0
getrest <- function(word,y){
  #Make new column
  wordinfo <- vector()
  formt <- str_extract_all(tolower(top5meta$name), boundary("word"))
  #Locate word
  wordloc <- grep(word, formt)
  #Iterate through locations and append data to list
  for(x in wordloc){
      wordinfo <- append(wordinfo, as.character(top5meta[[y]][x]))

  }
  wordvalue[,ncol(wordvalue)+1] <<- NA
  #Gets the max of a table, and its element
  top <- names(which.max(table(wordinfo)))
  rplace <- grep("", wordvalue[,ncol(wordvalue)])
  if(length(rplace) == 0 ){
    rplace <- 1
  }else{
    rplace <-  rplace + 1
    print(rplace)
  }
  
  #NAs
  if(length(top) == 0){
    #Grep finds how many elemnts are in the row, so it can index it properly
    wordvalue[rplace,(ncol(wordvalue))] <<- NA

  }
  else{
    wordvalue[rplace,(ncol(wordvalue))] <<- top
  }
}
#getrest("christmas", 15)
#For this I manually put in the columns because the function didn't work as planed
cat <- lapply(wlist, getrest, y = 29)
#Put it as a dataframe to append to wordvalue
temp <- as.data.frame(do.call("rbind", cat), stringsAsFactors = FALSE)
backup[,14] <- temp
#dog <- t(wordvalue[, 3:3454])
right <- dog[,1]
colnames(wordvalue) <- c("word","mood1","mood2","era","tempo1","tempo2","tempo3","artistorigin1","artistorigin2","genre1","genre2","genre3","grouptype1","grouptype2","count")
#add z scores and count for each word
wordvalue[,16:19] <- corectv5tes[,3:6]
#As.character changed numbers in title so they are unsearchable
num <- grep("X", wordvalue$word)
#Remove them
test <- wordvalue[-rnum,]
#write.table(top5meta, "formattedtop5meta.csv")
#write.table(wordvalue, "wordvaluemeta.csv")
write.table(test, "actualraveragewordvalues.csv")

```
##View of data

```{r}
wthzright  <- read.csv("top5000withz.csv")
head(wthzright)
values5000right <- read.csv("songvalues5000.csv")
head(values5000right)
corectv5right <- read.csv("5000popularitywords.csv")
head(corectv5right)
hereiswordv <- read.csv("wordvalue.csv")
head(hereiswordv)

```
